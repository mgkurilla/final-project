---
title: "datacleaning_csiyear"
author: "Michelle Kurilla"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(viridis)
library(rstanarm)
library(gt)
library(gtsummary)
library(DT)
```

# Read Initial CSI Index XLS File 

```{r}

# read excel file

csi_index <- 
    read_excel("CSI_1953_2014.xls")

```

# CSI Index by Year, by Decade

```{r}

# format data to be csi index by year

csi_index_by_year <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  group_by(caseId, CSI) %>%
  tally() %>%
  rename(totalCSI = n)

# format data to be csi index by decade

csi_index_by_decade <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
rowwise %>%
mutate(decade = str_sub(caseId, start = 1, end = 3)) %>%
group_by(decade, CSI) %>%
tally() %>%
rename(totalCSI_decade = n)

```

# Sort Mean and Median of CSI Index by Year

```{r}

mean_median_csi <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  rename(year = caseId) %>%
  group_by(year) %>%
  summarize(mean = mean(CSI), 
           median = median(CSI))

```

# Read Justice_Opinion CSV

```{r, message = FALSE, error = FALSE}

# Read justice_opinion_csv
# Set cols argument 

justice_opinion_excel <- read_csv("SCDB_2020_01_justiceCentered_Citation_2.csv",
                                  col_types = cols(
  .default = col_double(),
  caseId = col_character(),
  docketId = col_character(),
  caseIssuesId = col_character(),
  voteId = col_character(),
  dateDecision = col_character(),
  usCite = col_character(),
  sctCite = col_character(),
  ledCite = col_character(),
  lexisCite = col_character(),
  chief = col_character(),
  caseName = col_character(),
  dateArgument = col_character(),
  dateRearg = col_character(),
  lawMinor = col_character(),
  justiceName = col_character()
))

```

# Sum Cases by Chief Justices 

```{r}

justice_cases_sum <-
  
# pipe in justice_opinion_excel tibble
  
justice_opinion_excel %>%
  
# select columns to work with 
  
select(caseId, majOpinWriter) %>%
  
# the columns repeat; use distinct() function 
  
distinct() %>%
  
# mutate caseId to only include first four digits
  
mutate(caseId = str_sub(caseId, 1, 4)) %>%
  
# drop na values
  
drop_na() %>%
  
# filter to only chief justices
  
filter(majOpinWriter %in% c(90, 99, 102, 111)) %>%
  
# group by chief justices and caseId
  
group_by(majOpinWriter, caseId) %>%
  
# tally the total number of cases
  
tally() %>%

# rename n to total cases assigned
  
rename(total_cases_assigned = n) %>%
  
# rename the four digit caseId code to year 
  
rename(year = caseId)

```


# Justice CSV (join CSI and Justice Opinion Excel)

```{r}

# create inner_join of two databases

joined_csv <- inner_join(csi_index, justice_opinion_excel, by = "caseId")

```

# Case Sum by Justice (Sum Total)

```{r}

judge_cases_sum <-
  
  # pipe in justice_opinion_excel
  
  justice_opinion_excel %>%
  
  # select columns to work with 
  
  select(caseId, majOpinWriter, majOpinAssigner) %>%
  
  # only use distinct() rows
  
  distinct() %>%
  
  # mutate caseId to get rid of trailing ID numbers
  
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  
  # drop na values
  
  drop_na() %>%
  
  # filter so that the Chief Justice both assigned and wrote the opinion 
  
  filter(majOpinWriter %in% c(90, 99, 102, 111), 
         majOpinAssigner %in% c(90, 99, 102, 111)) %>%
  filter(majOpinAssigner == majOpinWriter) %>%
  
  # rename to actual justice names 
  
  mutate(writer_name = case_when(majOpinWriter == 90 ~ "Warren", 
            majOpinWriter == 99 ~ "Burger", 
            majOpinWriter == 102 ~ "Rehnquist", 
            majOpinWriter == 111 ~ "Roberts")) %>% 
  mutate(assigner_name = case_when(majOpinAssigner == 90 ~ "Warren", 
            majOpinAssigner == 99 ~ "Burger", 
            majOpinAssigner == 102 ~ "Rehnquist", 
            majOpinAssigner == 111 ~ "Roberts")) %>%
  
  # group_by names and caseId 
  
  group_by(writer_name, caseId) %>%
  
  # tally total cases
  
  tally() %>%
  
  # rename n to total cases written 
  
  rename(total_cases_written = n) %>%
  
  # rename mutated caseId to year it was written
  
  rename(year = caseId)

```

## Modeling (Make "Test" with Joined CSV)

```{r}

joined_csv_equal <- 
  
  # pipe in joined csv
  
  joined_csv %>%
  
  # select columns to work with 
  
  select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
  
  # filter to distinct data
  
  distinct() %>%
  
  # drop na values
  
  drop_na() %>%
  
  # mutate to create test column 
  
  mutate(test = if_else(majOpinAssigner == majOpinWriter, 1, 0)) 


```

## Modeling (Make Stan GLMs)

```{r}

# create stan_glm
# use data created above
# don't forget to set refresh = 0 

fit_obj_test <- stan_glm(CSI ~ test,
                         data = joined_csv_equal, 
                         refresh = 0)

```


## GT Table by hnad 

```{r}

# manually set gt from stan_glm above

regression_1 <- tibble(coefficient = 0.8438, 
                       intercept = 2.6709)

gt(regression_1)

```

# Create regression data tibble

```{r}

# Create regression tibble with CSI info from regression gt and interpretation

regression_data <- tibble(CSI = c("2.6709", "3.514"), 
                          test = c("0", "1"))

```


# Create regression chart 

```{r}

# Pull regression data tibble from above
# Set x axis to CSI and y axis to test
# Set group = 1 to have line

ggplot(regression_data, aes(x = CSI, y = test, group = 1)) +
geom_point() + 
geom_line() + 
theme_classic() + 
labs(title = "Linear Regression of Supreme Court Case Salience",
  x = "Median CSI", 
  y = "Test")

```


  








