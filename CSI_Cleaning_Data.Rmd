---
title: "datacleaning_csiyear"
author: "Michelle Kurilla"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(viridis)
library(rstanarm)
```

## Read Initial CSI Index XLS File 

```{r}
csi_index <- 
    read_excel("CSI_1953_2014.xls")

# create new column that only uses first four digits and then convert strings to number
# save into dataframe then rds 
# read the rds into app.r 

```

## CSI Index by Year, by Decade

```{r}

# format data to be csi index by year

csi_index_by_year <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  group_by(caseId, CSI) %>%
  tally() %>%
  rename(totalCSI = n)

# format data to be csi index by decade

csi_index_by_decade <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
rowwise %>%
mutate(decade = str_sub(caseId, start = 1, end = 3)) %>%
group_by(decade, CSI) %>%
tally() %>%
rename(totalCSI_decade = n)

```

## Sort Mean and Median of CSI Index by Year

```{r}

mean_median_csi <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  rename(year = caseId) %>%
  group_by(year) %>%
  summarize(mean = mean(CSI), 
           median = median(CSI))

mean_median_csi
```

## Read Justice_Opinion CSV

```{r}

justice_opinion_excel <- read_csv("SCDB_2020_01_justiceCentered_Citation_2.csv",
                                  col_types = cols(
  .default = col_double(),
  caseId = col_character(),
  docketId = col_character(),
  caseIssuesId = col_character(),
  voteId = col_character(),
  dateDecision = col_character(),
  usCite = col_character(),
  sctCite = col_character(),
  ledCite = col_character(),
  lexisCite = col_character(),
  chief = col_character(),
  caseName = col_character(),
  dateArgument = col_character(),
  dateRearg = col_character(),
  lawMinor = col_character(),
  justiceName = col_character()
))

```


## Sum Cases by Chief Justices 

```{r}

# Cases Assigned by Chief Justices
justice_cases_sum <-
justice_opinion_excel %>%
select(caseId, majOpinWriter) %>%
distinct() %>%
mutate(caseId = str_sub(caseId, 1, 4)) %>%
drop_na() %>%
filter(majOpinWriter %in% c(90, 99, 102, 111)) %>%
group_by(majOpinWriter, caseId) %>%
tally() %>%
rename(total_cases_assigned = n) %>%
rename(year = caseId)

```


## Justice CSV (join CSI and Justice Opinion Excel)

```{r}

joined_csv <- inner_join(csi_index, justice_opinion_excel, by = "caseId")

```


## Case Frequency by Justice

```{r}

chief_justice_cases <- joined_csv %>%
  select(caseId, majOpinWriter) %>%
  distinct() %>%
  filter(majOpinWriter %in% c(90, 99, 102, 111)) %>%
  group_by(caseId, majOpinWriter) %>%
  tally() 

chief_justice_frequency <- joined_csv %>%
select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
distinct() %>%
filter(majOpinAssigner %in% c(90, 99, 102, 111) & 
       majOpinWriter %in% c(90, 99, 102, 111)) %>%
group_by(CSI, majOpinWriter, majOpinAssigner) %>%
tally() %>%
rename(total_csi_cases = n) 

```

## Case Sum by Justice (Sum Total)

```{r}

judge_cases_sum <-
  justice_opinion_excel %>%
  select(caseId, majOpinWriter, majOpinAssigner) %>%
  distinct() %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  drop_na() %>%
  filter(majOpinWriter %in% c(90, 99, 102, 111), 
         majOpinAssigner %in% c(90, 99, 102, 111)) %>%
  filter(majOpinAssigner == majOpinWriter) %>%
  mutate(writer_name = case_when(majOpinWriter == 90 ~ "Warren", 
            majOpinWriter == 99 ~ "Burger", 
            majOpinWriter == 102 ~ "Rhenquist", 
            majOpinWriter == 111 ~ "Roberts")) %>% 
  mutate(assigner_name = case_when(majOpinAssigner == 90 ~ "Warren", 
            majOpinAssigner == 99 ~ "Burger", 
            majOpinAssigner == 102 ~ "Rhenquist", 
            majOpinAssigner == 111 ~ "Roberts")) %>%
  group_by(writer_name, caseId) %>%
  tally() %>%
  rename(total_cases_written = n) %>%
  rename(year = caseId)


  
View(judge_cases_sum)

```

## Modeling (Make "Test" with Joined CSV)

```{r}

View(joined_csv)

joined_csv_equal <- joined_csv %>%
  select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
  distinct() %>%
  drop_na() %>%
  mutate(test = if_else(majOpinAssigner == majOpinWriter, 1, 0)) 

# filter(majOpinAssigner %in% c(90, 99, 102, 111) &
 #          majOpinWriter %in% c(90, 99, 102, 111)) %>%
# add column justifying why dropping na 

joined_csv_equal

```

## Creating Year for Model

```{r}


joined_csv_year <-
joined_csv %>%
  select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
  distinct() %>%
  drop_na() %>%
  mutate(test = if_else(majOpinAssigner == majOpinWriter, 1, 0)) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  rename(year = caseId) %>%
  mutate(year = as.numeric(year))
  
joined_csv_year 

#  group_by(year) %>%
#  summarize(sum_year = sum(CSI))




```

## Modeling (Make Stan GLMs)

```{r}

fit_obj_1 <- stan_glm(CSI ~ test,
                         data = joined_csv_equal,
                          refresh = 0)

print(fit_obj_1, digits = 4)


#fit_obj_2 <- stan_glm(CSI ~ test + nyScore + laScore + )

fit_obj_3 <- stan_glm(CSI ~ test + year, 
                     data = joined_csv_year, 
                     refresh = 0)

print(fit_obj_3, digits = 4)

```

# Workflow

```{r}

joined_split <- initial_split(joined_csv_equal, prob = 0.8) 
joined_train <- training(joined_split)
joined_test <- testing(joined_split)

joined_wfl <- workflow() %>%
  add_model(linear_reg() %>%
            set_engine("lm") %>%
            set_mode("regression")) %>%
  add_recipe(recipe(CSI ~ test, data = joined_train) %>%
               step_dummy(all_nominal()))

joined_results <- joined_wfl %>%
  fit(data = joined_train) %>%
  predict(new_data = joined_test) %>%
  bind_cols(joined_test %>% select(CSI)) %>%
  rmse(truth = CSI, estimate = .pred) %>%
  rename(error = .estimate) %>%
  select(error)

```








