---
title: "datacleaning_csiyear"
author: "Michelle Kurilla"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(viridis)
library(rstanarm)
```

## R Markdown

```{r}
csi_index <- 
    read_excel("CSI_1953_2014.xls")

# create new column that only uses first four digits and then convert strings to number
# save into dataframe then rds 
# read the rds into app.r 

```

```{r}
csi_index_by_year <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
  group_by(caseId, CSI) %>%
  tally() %>%
  rename(totalCSI = n)

csi_index_by_year

```

```{r}
data <- csi_index_by_year 
  
  ggplot(data, mapping = aes(x = totalCSI, fill = factor(CSI))) + 
  geom_bar() + 
  scale_color_viridis_c(palette = "virdis")
  labs(title = "CSI by Year", 
            x = "CSI", 
            y = "Total Count of CSI") 
```

```{r}

csi_index_by_decade <- csi_index %>%
  select(caseId, CSI) %>%
  mutate(caseId = str_sub(caseId, 1, 4)) %>%
rowwise %>%
mutate(decade = str_sub(caseId, start = 1, end = 3)) %>%
group_by(decade, CSI) %>%
tally() %>%
  rename(totalCSI_decade = n)
  
# NEED TO ADD 0 TO THIS 
csi_index_by_decade
```
```{r}

# input for shiny

# tabPanel("CSI Index by Decade",  
#    titlePanel("CSI Index Frequency by Decade"), 
#    selectInput(
#      inputId = "csi_index_by_decade",
#      label = "Decade",
#      choices = c("195", "196", "197", "198", "199", 
#                  "200", "201")),
#    mainPanel(plotOutput("csi_hist_decade")))


# output for shiny 

# output$csi_hist_decade <- renderPlot({
#          data <- csi_index_by_decade %>% 
#            filter(decade == input$csi_index_by_decade)
#          ggplot(data, mapping = aes(x = totalCSI_decade, fill = factor(CSI))) + 
#            geom_bar() + 
#            theme_bw() + 
#            labs(title = "CSI by Decade", 
#                 x = "CSI", 
#                 y = "Total Count of CSI")

```

## Justice CSV (sums)

```{r}

justice_opinion_excel <- read_csv("SCDB_2020_01_justiceCentered_Citation_2.csv")


# Cases Assigned
justice_opinion_excel %>%
select(caseId, majOpinWriter, majOpinAssigner) %>%
distinct() %>%
filter(caseId >= 1953) %>%
drop_na() %>%
group_by(majOpinAssigner, caseId) %>%
tally() %>%
rename(total_cases_assigned = n)

# what to do about NA
# count as 0 ? 
  

# Cases Written
justice_opinion_excel %>%
select(caseId, majOpinWriter, majOpinAssigner) %>%
distinct() %>%
filter(caseId >= 1953) %>%
drop_na() %>%
group_by(majOpinWriter, caseId) %>%
tally() %>%
rename(total_cases_written = n)

# formula: CSI ~ majOpinWriter + majOpinAssigner


# if RMSE is lower if year is added

# chief justice writer & assigner (2 models & comparison)
# stan_glm fine for lm model

```

## Justice CSV (majOpinWriter, majOpinAssigner, CSI index, caseId)

```{r}

joined_csv <- inner_join(csi_index, justice_opinion_excel, by = "caseId")

View(joined_csv)


chief_justice_frequency <- joined_csv %>%
select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
distinct() %>%
filter(majOpinAssigner %in% c(90, 99, 102, 111) & 
       majOpinWriter %in% c(90, 99, 102, 111)) %>%
group_by(CSI, majOpinWriter, majOpinAssigner) %>%
tally() %>%
rename(total_csi_cases = n)
chief_justice_frequency


# want majOpinAssigner & majOpinWriter equal to chief justices 


# http://scdb.wustl.edu/documentation.php?var=majOpinAssigner

# possibly drop_na()


```


## Modeling 

```{r}

joined_csv_equal <- joined_csv %>%
  select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
  distinct() %>%
  filter(majOpinAssigner %in% c(90, 99, 102, 111) &
           majOpinWriter %in% c(90, 99, 102, 111)) %>%
  mutate(test = if_else(majOpinAssigner == majOpinWriter, 1, 0)) 


fit_obj_1 <- stan_glm(CSI ~ test,
                         data = joined_csv_equal,
                          refresh = 0)

fit_obj_2 <- stan_glm(CSI ~ majOpinWriter + majOpinAssigner + test,
                            data = joined_csv_equal, 
                            refresh = 0)

joined_split <- initial_split(joined_csv_equal, prob = 0.8) 
joined_train <- training(joined_split)
joined_test <- testing(joined_split)

joined_wfl <- workflow() %>%
  add_model(linear_reg() %>%
            set_engine("lm") %>%
            set_mode("regression")) %>%
  add_recipe(recipe(CSI ~ test, data = joined_train) %>%
               step_dummy(all_nominal()))

joined_results <- joined_wfl %>%
  fit(data = joined_train) %>%
  predict(new_data = joined_test) %>%
  bind_cols(joined_test %>% select(CSI)) %>%
  rmse(truth = CSI, estimate = .pred) %>%
  rename(error = .estimate) %>%
  select(error)


```


## Code from Old Modeling

```{r}

# joined_csv_not_equal <- joined_csv %>%
#  select(CSI, caseId, majOpinWriter, majOpinAssigner) %>%
#  distinct() %>%
#  filter(majOpinAssigner %in% c(90, 99, 102, 111) &
#           majOpinWriter %in% c(90, 99, 102, 111)) %>%
#  group_by(CSI, majOpinWriter, majOpinAssigner) %>%
#  tally() %>%
#  rename(total_csi_cases = n)

#fit_obj_equal <- stan_glm(CSI ~ majOpinWriter + majOpinAssigner,
#                          data = joined_csv_equal,
#                          refresh = 0)

#fit_obj_not_equal <- stan_glm(CSI ~ majOpinWriter + majOpinAssigner,
#                                    data = joined_csv_not_equal,
#                                    refresh = 0)

#print(fit_obj_equal, digits = 4)
#print(fit_obj_not_equal, digits = 4)

# bad (modeling the 90, 99)
# add year 
```





## Vision of the Project

Tab for CSI Index (by Paper, by Decade, by Year)
Tab for Justices (by Chief Justice and number of cases assigned)
Tab for Justices as it relates to CSI 
